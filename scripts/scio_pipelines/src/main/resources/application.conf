// Spotify data pipeline configuration

spotify.pipeline {
  // Environment settings
  env = "dev"
  env = ${?PIPELINE_ENV}  // Can be overridden with environment variable
  
  // Database configurations
  db {
    // Raw database settings (source)
    raw {
      driver = "org.postgresql.Driver"
      url = "jdbc:postgresql://postgres:5432/spotify_raw"
      url = ${?DB_RAW_URL}  // Can be overridden with environment variable
      user = "postgres"
      user = ${?DB_USER}
      password = "postgres"
      password = ${?DB_PASSWORD}
      
      // Connection pool settings
      connection-pool {
        max-connections = 10
        timeout-millis = 30000
        max-lifetime-millis = 1800000
      }
    }
    
    // Analytics database settings (destination)
    analytics {
      driver = "org.postgresql.Driver"
      url = "jdbc:postgresql://postgres:5432/spotify_analytics"
      url = ${?DB_ANALYTICS_URL}  // Can be overridden with environment variable
      user = "postgres"
      user = ${?DB_USER}
      password = "postgres"
      password = ${?DB_PASSWORD}
      
      // Connection pool settings
      connection-pool {
        max-connections = 10
        timeout-millis = 30000
        max-lifetime-millis = 1800000
      }
    }
  }
  
  // Beam settings
  beam {
    // Runner selection (DirectRunner for local development, DataflowRunner for cloud)
    runner = "direct"  // "direct" or "dataflow"
    runner = ${?BEAM_RUNNER}
    
    // GCP settings for Dataflow
    project = "spotify-pipeline"
    project = ${?BEAM_PROJECT}
    temp-location = "gs://spotify-pipeline-temp"
    temp-location = ${?BEAM_TEMP_LOCATION}
    
    // Pipeline tuning
    num-shards = 10
    batch-size = 1000
  }
  
  // Pipeline-specific settings
  pipelines {
    // Streaming history transform settings
    streaming-history {
      // Extract query for streaming history data
      extract-query = """
        SELECT
          event_id,
          user_id,
          track_id,
          played_at,
          ms_played,
          reason_start,
          reason_end,
          device_type,
          country
        FROM
          streaming_history
        WHERE
          played_at >= ? AND played_at < ?
      """
      
      // Batch size for JDBC operations
      write-batch-size = 1000
      
      // Environment-specific configurations
      environments {
        dev {
          // Development specific overrides
          parallelism = 2
        }
        
        prod {
          // Production specific overrides
          parallelism = 10
          write-batch-size = 5000
        }
      }
    }
  }
}

// Environment-specific configurations
dev {
  spotify.pipeline {
    // Development configuration overrides
    db {
      raw.connection-pool.max-connections = 5
      analytics.connection-pool.max-connections = 5
    }
    
    beam {
      runner = "direct"
    }
  }
}

prod {
  spotify.pipeline {
    // Production configuration overrides
    db {
      raw.connection-pool.max-connections = 20
      analytics.connection-pool.max-connections = 20
    }
    
    beam {
      runner = "dataflow"
      num-shards = 50
      batch-size = 5000
    }
  }
} 